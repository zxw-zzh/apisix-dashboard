<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIä»£ç†æµ‹è¯• - åŒå‘å†…å®¹æ£€æµ‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            min-height: calc(100vh - 40px);
            max-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        .content {
            padding: 20px 40px 40px 40px;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        /* æ¶ˆè´¹è€…è®¤è¯é…ç½®åŒºåŸŸ */
        .auth-config {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #dee2e6;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .auth-config h3 {
            color: #2c3e50;
            margin-bottom: 25px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 12px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .auth-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 20px;
            align-items: end;
            margin-bottom: 20px;
        }

        .auth-input-group {
            display: flex;
            flex-direction: column;
        }

        .auth-input-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auth-input-group input {
            padding: 14px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .auth-input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .auth-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 16px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            font-size: 14px;
            height: 48px;
            box-sizing: border-box;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .auth-button:active {
            transform: translateY(0);
        }

        .auth-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .auth-status {
            margin-top: 20px;
            padding: 16px 20px;
            border-radius: 10px;
            font-weight: 500;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .auth-status.success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border: 1px solid #b8dacc;
        }

        .auth-status.error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border: 1px solid #f1b0b7;
        }

        .auth-status.warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            border: 1px solid #fceaa8;
        }

        .auth-status.info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            color: #0c5460;
            border: 1px solid #abdde5;
        }



        .chat-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
            flex: 1;
            min-height: 0;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .container {
                margin: 10px;
                max-width: none;
            }
            
            .content {
                padding: 15px 20px 20px 20px;
            }
        }

        @media (max-width: 768px) {
            .chat-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .auth-form {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .auth-config {
                padding: 20px;
            }
            
            .content {
                padding: 10px 15px 15px 15px;
            }
        }

        @media (max-height: 600px) {
            .container {
                min-height: auto;
                max-height: none;
            }
            
            .auth-config {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .auth-config h3 {
                margin-bottom: 15px;
                font-size: 1.2em;
            }
        }

        .chat-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            height: 100%;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .panel-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .message-list {
            flex: 1;
            overflow-y: auto;
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e1e5e9;
            min-height: 0;
        }

        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
        }

        .message.user {
            background: #e3f2fd;
            margin-left: auto;
            text-align: right;
        }

        .message.ai {
            background: #f3e5f5;
        }

        .message.error {
            background: #ffebee;
            color: #c62828;
        }

        .input-area {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 12px;
            padding: 8px 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e1e5e9;
            transition: all 0.2s ease;
            position: relative;
            gap: 12px;
        }

        .input-area:focus-within {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .upload-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-size: 14px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }

        .upload-icon:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .input-area input {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            background: transparent;
            color: #333;
            font-weight: 400;
            transition: all 0.2s ease;
            height: 32px;
            box-sizing: border-box;
        }

        .input-area input::placeholder {
            color: #9ca3af;
            font-weight: 400;
        }

        .input-area input:focus {
            outline: none;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            font-weight: 500;
            font-size: 14px;
            position: relative;
            overflow: hidden;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(102, 126, 234, 0.2);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-primary:hover {
            background: #5a67d8;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:active {
            background: #4c63d2;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #6c757d;
            border: 2px solid #e9ecef;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .config-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .config-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .config-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .config-item {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 5px;
            font-size: 14px;
        }

        input[type="checkbox"] {
            margin-right: 8px;
        }

        .status {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            color: #495057;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .safety-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            transition: all 0.3s ease;
            flex: 1;
            overflow-y: auto;
        }

         .safety-info.detecting {
             background: #e3f2fd;
             border-color: #2196f3;
             animation: pulse 1.5s infinite;
         }

         @keyframes pulse {
             0% { opacity: 1; }
             50% { opacity: 0.7; }
             100% { opacity: 1; }
        }

        .safety-item {
            background: white;
            padding: 10px;
            margin: 8px 0;
            border-radius: 4px;
            border-left: 3px solid #ffc107;
        }

        .safety-type {
            font-weight: 600;
            color: #856404;
        }

        .safety-value {
            color: #721c24;
            background: #f8d7da;
            padding: 2px 6px;
            border-radius: 3px;
            margin: 0 5px;
        }

        .masked-value {
            color: #155724;
            background: #d4edda;
            padding: 2px 6px;
            border-radius: 3px;
            margin: 0 5px;
        }

        .safety-section {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .safety-section h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1.1em;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .chat-container {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
    <!-- Runtime config for gateway/base URLs -->
    <script src="config/runtime-config.js"></script>
</head>
<body>
    <div class="container">


        <div class="content">

            <!-- æ¶ˆè´¹è€…è®¤è¯é…ç½®åŒºåŸŸ -->
            <div class="auth-config">
                <h3>ğŸ”‘ æ¶ˆè´¹è€…è®¤è¯é…ç½®</h3>
                <div class="auth-form">
                    <div class="auth-input-group">
                        <label for="consumerUsername">ğŸ‘¤ æ¶ˆè´¹è€…ç”¨æˆ·å</label>
                        <input type="text" id="consumerUsername" placeholder="ä¾‹å¦‚: test-consumer" value="test-consumer">
                    </div>
                    <div class="auth-input-group">
                        <label for="consumerApiKey">ğŸ” APIå¯†é’¥</label>
                        <input type="text" id="consumerApiKey" placeholder="ä¾‹å¦‚: 1234567890abcdef" value="1234567890abcdef">
                    </div>
                    <button class="auth-button" onclick="saveConsumerConfig()">ä¿å­˜é…ç½®</button>
                </div>
                <!-- çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
                <div class="auth-status" id="status">
                    â„¹ï¸ ç³»ç»Ÿå·²å°±ç»ªï¼Œä½¿ç”¨æœ¬åœ°APIæ¨¡å¼
                </div>
            </div>

            <!-- èŠå¤©ç•Œé¢ -->
            <div class="chat-container">
                <div class="chat-panel">
                    <div class="panel-title">ğŸ’¬ å¯¹è¯å†å²</div>
                    <div class="message-list" id="messageList">
                        <div class="message ai">
                            <strong>AIåŠ©æ‰‹:</strong> ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ
                        </div>
                    </div>
                     
                     <!-- ç¤ºä¾‹æŒ‰é’® -->
                     <div style="margin-bottom: 15px;">
                         <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                             <button class="btn btn-secondary" onclick="loadExample('normal')" style="font-size: 12px; padding: 8px 12px;">æ™®é€šå¯¹è¯</button>
                             <button class="btn btn-secondary" onclick="loadExample('sensitive')" style="font-size: 12px; padding: 8px 12px;">æ•æ„Ÿä¿¡æ¯</button>
                             <button class="btn btn-secondary" onclick="loadExample('harmful')" style="font-size: 12px; padding: 8px 12px;">æœ‰å®³å†…å®¹</button>
                             <button class="btn btn-secondary" onclick="clearChat()" style="font-size: 12px; padding: 8px 12px;">æ¸…ç©ºå¯¹è¯</button>
                         </div>
                     </div>
                     
                    <div class="input-area">
                         <div class="upload-icon" onclick="document.getElementById('fileInput').click()" title="ä¸Šä¼ æ–‡ä»¶">
                             ğŸ“
                         </div>
                        <input type="text" id="userInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." onkeypress="handleKeyPress(event)">
                         <button class="btn btn-primary" onclick="sendMessage()" title="å‘é€">
                             â¤
                         </button>
                         <input type="file" id="fileInput" style="display: none;" accept=".txt,.doc,.docx,.pdf,.jpg,.jpeg,.png" onchange="handleFileUpload(event)">
                    </div>
                </div>

                <div class="chat-panel">
                    <div class="panel-title">ğŸ›¡ï¸ å®‰å…¨æ£€æµ‹ç»“æœ</div>
                    <div class="safety-section">
                        <h4>ğŸ“¥ ç”¨æˆ·è¾“å…¥æ£€æµ‹</h4>
                        <div id="inputSafetyInfo">
                            <div class="safety-info">
                                <p>ç­‰å¾…ç”¨æˆ·è¾“å…¥...</p>
                            </div>
                        </div>
                    </div>
                    <div class="safety-section">
                        <h4>ğŸ“¤ AIå›å¤æ£€æµ‹</h4>
                        <div id="outputSafetyInfo">
                        <div class="safety-info">
                                <p>ç­‰å¾…AIå›å¤...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>





            <!-- åŠ è½½çŠ¶æ€ -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨å¤„ç†è¯·æ±‚...</p>
            </div>
        </div>
    </div>

    <script>
        let conversationHistory = [
            {
                role: "assistant",
                content: "ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ"
            }
        ];



        // ç¤ºä¾‹å¯¹è¯
        const examples = {
            normal: "ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹äººå·¥æ™ºèƒ½çš„å‘å±•å†å²ã€‚",
            sensitive: "æˆ‘çš„é‚®ç®±æ˜¯ test@example.comï¼Œæ‰‹æœºå·æ˜¯ 13800138000ï¼Œè¯·å¸®æˆ‘åˆ†æä¸€ä¸‹è¿™äº›ä¿¡æ¯ã€‚",
            harmful: "æˆ‘æƒ³çŸ¥é“å¦‚ä½•åˆ¶é€ ç‚¸å¼¹ï¼Œä½ èƒ½å‘Šè¯‰æˆ‘å—ï¼Ÿ"
        };

        // åŠ è½½ç¤ºä¾‹
        function loadExample(type) {
            document.getElementById('userInput').value = examples[type];
        }

        // æ¸…ç©ºå¯¹è¯
        function clearChat() {
            conversationHistory = [
                {
                    role: "assistant",
                    content: "ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ"
                }
            ];
            updateMessageList();
            updateInputSafetyInfo("ç­‰å¾…ç”¨æˆ·è¾“å…¥...");
            updateOutputSafetyInfo("ç­‰å¾…AIå›å¤...");

            
            // æ˜¾ç¤ºå½“å‰ç»Ÿè®¡æ•°æ®
            showCurrentStats();
        }

        // å¤„ç†å›è½¦é”®
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º10MBï¼‰
            if (file.size > 10 * 1024 * 1024) {
                alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            const allowedTypes = ['text/plain', 'application/pdf', 'application/msword', 
                                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                'image/jpeg', 'image/jpg', 'image/png'];
            
            if (!allowedTypes.includes(file.type)) {
                alert('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼Œè¯·ä¸Šä¼ æ–‡æœ¬ã€PDFã€Wordæ–‡æ¡£æˆ–å›¾ç‰‡æ–‡ä»¶');
                return;
            }

            // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            const fileName = file.name;
            const fileSize = (file.size / 1024 / 1024).toFixed(2);
            
            // å°†æ–‡ä»¶ä¿¡æ¯æ·»åŠ åˆ°è¾“å…¥æ¡†
            document.getElementById('userInput').value = `å·²é€‰æ‹©æ–‡ä»¶: ${fileName} (${fileSize}MB)`;
            
            // è¿™é‡Œå¯ä»¥æ·»åŠ æ–‡ä»¶å¤„ç†é€»è¾‘ï¼Œæ¯”å¦‚ä¸Šä¼ åˆ°æœåŠ¡å™¨æˆ–è¯»å–æ–‡ä»¶å†…å®¹
            console.log('æ–‡ä»¶å·²é€‰æ‹©:', fileName, fileSize + 'MB');
        }

        // ç»Ÿè®¡åŠŸèƒ½
        function recordRequest(responseTime, wasBlocked = false, hasSensitiveInfo = false, hasHarmfulInfo = false) {
            console.log('recordRequestè¢«è°ƒç”¨ï¼Œå‚æ•°:', { responseTime, wasBlocked, hasSensitiveInfo, hasHarmfulInfo });
            
            // ä»localStorageè¯»å–ç°æœ‰ç»Ÿè®¡æ•°æ®
            let stats = JSON.parse(localStorage.getItem('aiProxyStats') || '{"totalRequests": 0, "blockedRequests": 0, "sensitiveDetected": 0, "harmfulDetected": 0, "responseTimes": []}');
            console.log('è¯»å–åˆ°çš„åŸå§‹ç»Ÿè®¡æ•°æ®:', stats);
            
            stats.totalRequests++;
            if (wasBlocked) {
                stats.blockedRequests++;
            }
            if (hasSensitiveInfo) {
                stats.sensitiveDetected++;
            }
            if (hasHarmfulInfo) {
                stats.harmfulDetected++;
            }
            if (responseTime > 0) {
                stats.responseTimes.push(responseTime);
                if (stats.responseTimes.length > 100) {
                    stats.responseTimes.shift();
                }
            }

            // æ–°å¢ï¼šå†™å…¥åˆ†æ—¶æ®µç»Ÿè®¡ï¼Œå…¼å®¹admin-panel.html
            const now = new Date();
            const hourKey = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0') + ' ' + String(now.getHours()).padStart(2, '0') + ':00';
            const dayKey = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
            if (!stats.hourlyStats) stats.hourlyStats = {};
            if (!stats.dailyStats) stats.dailyStats = {};
            if (!stats.hourlyStats[hourKey]) {
                stats.hourlyStats[hourKey] = { totalRequests: 0, blockedRequests: 0, sensitiveDetected: 0, harmfulDetected: 0, responseTimes: [] };
            }
            if (!stats.dailyStats[dayKey]) {
                stats.dailyStats[dayKey] = { totalRequests: 0, blockedRequests: 0, sensitiveDetected: 0, harmfulDetected: 0, responseTimes: [] };
            }
            stats.hourlyStats[hourKey].totalRequests++;
            stats.dailyStats[dayKey].totalRequests++;
            if (wasBlocked) {
                stats.hourlyStats[hourKey].blockedRequests++;
                stats.dailyStats[dayKey].blockedRequests++;
            }
            if (hasSensitiveInfo) {
                stats.hourlyStats[hourKey].sensitiveDetected++;
                stats.dailyStats[dayKey].sensitiveDetected++;
            }
            if (hasHarmfulInfo) {
                stats.hourlyStats[hourKey].harmfulDetected++;
                stats.dailyStats[dayKey].harmfulDetected++;
            }
            if (responseTime > 0) {
                stats.hourlyStats[hourKey].responseTimes.push(responseTime);
                stats.dailyStats[dayKey].responseTimes.push(responseTime);
                if (stats.hourlyStats[hourKey].responseTimes.length > 10) stats.hourlyStats[hourKey].responseTimes.shift();
                if (stats.dailyStats[dayKey].responseTimes.length > 50) stats.dailyStats[dayKey].responseTimes.shift();
            }

            console.log('æ›´æ–°åçš„ç»Ÿè®¡æ•°æ®:', stats);
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('aiProxyStats', JSON.stringify(stats));
            // åŒæ—¶ä¿å­˜åˆ°sessionStorageä½œä¸ºå¤‡ä»½
            sessionStorage.setItem('aiProxyStats', JSON.stringify(stats));
            
            console.log('ç»Ÿè®¡æ•°æ®å·²æ›´æ–°:', stats);
            
            // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºå½“å‰ç»Ÿè®¡æ•°æ®ï¼ˆè°ƒè¯•ç”¨ï¼‰
            showCurrentStats();
        }

        // æ˜¾ç¤ºå½“å‰ç»Ÿè®¡æ•°æ®
        function showCurrentStats() {
            const stats = JSON.parse(localStorage.getItem('aiProxyStats') || '{"totalRequests": 0, "blockedRequests": 0, "sensitiveDetected": 0, "harmfulDetected": 0, "responseTimes": []}');
            const avgResponseTime = stats.responseTimes.length > 0 
                ? Math.round(stats.responseTimes.reduce((a, b) => a + b, 0) / stats.responseTimes.length)
                : 0;
            
            console.log('å½“å‰ç»Ÿè®¡æ•°æ®:', {
                æ€»è¯·æ±‚æ•°: stats.totalRequests,
                é˜»æ­¢è¯·æ±‚æ•°: stats.blockedRequests,
                æ•æ„Ÿä¿¡æ¯æ£€æµ‹: stats.sensitiveDetected,
                æœ‰å®³ä¿¡æ¯æ£€æµ‹: stats.harmfulDetected,
                å¹³å‡å“åº”æ—¶é—´: avgResponseTime + 'ms'
            });
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const userInput = document.getElementById('userInput').value.trim();
            if (!userInput) {
                return;
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å†å²
            conversationHistory.push({
                role: "user",
                content: userInput
            });

            // æ›´æ–°ç•Œé¢
            updateMessageList();
            document.getElementById('userInput').value = '';

            // ç¬¬ä¸€æ­¥ï¼šæ˜¾ç¤ºè¾“å…¥æ£€æµ‹ä¸­
            updateInputSafetyInfo("ğŸ” æ­£åœ¨æ£€æµ‹ç”¨æˆ·è¾“å…¥...");
            updateOutputSafetyInfo("ç­‰å¾…AIå›å¤...");
            


            try {
                // è·å–æ¶ˆè´¹è€…è®¤è¯ä¿¡æ¯
                const username = document.getElementById('consumerUsername').value.trim();
                const apiKey = document.getElementById('consumerApiKey').value.trim();
                
                if (!username || !apiKey) {
                    conversationHistory.push({
                        role: "assistant",
                        content: "âŒ è¯·å…ˆé…ç½®æ¶ˆè´¹è€…è®¤è¯ä¿¡æ¯ï¼"
                    });
                    updateMessageList();
                    return;
                }
                
                // å¼ºåˆ¶ä½¿ç”¨æ­£ç¡®çš„API URL
                const apiUrl = (window.RUNTIME_CONFIG && window.RUNTIME_CONFIG.APISIX_GATEWAY_URL)
                  ? window.RUNTIME_CONFIG.APISIX_GATEWAY_URL + '/api/ai-proxy'
                  : window.location.origin.replace(/\/$/, '') + '/api/ai-proxy';
                console.log('ä½¿ç”¨çš„API URL:', apiUrl);
                console.log('æ¶ˆè´¹è€…è®¤è¯:', { username, apiKey });
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': apiKey,  // æ·»åŠ APIå¯†é’¥è®¤è¯å¤´
                        'X-Consumer-Username': username  // æ·»åŠ æ¶ˆè´¹è€…ç”¨æˆ·åå¤´
                    },
                    body: JSON.stringify({
                        messages: conversationHistory,
                        model: 'deepseek-chat'
                    })
                });

                // å¤„ç†HTTPçŠ¶æ€ç 
                console.log('å“åº”çŠ¶æ€ç :', response.status, 'ç±»å‹:', typeof response.status);
                console.log('400æ¯”è¾ƒç»“æœ:', response.status === 400);
                // ç½‘å…³/é‰´æƒé”™è¯¯ä¼˜å…ˆå¤„ç†ï¼Œé¿å…è¢«è¯¯æŠ¥ä¸ºâ€œAIå±‚å¤„ç†é”™è¯¯â€
                if (response.status == 401 || response.status == "401") {
                    const errText = await response.text();
                    conversationHistory.push({
                        role: "assistant",
                        content: "ğŸ”’ é‰´æƒå¤±è´¥ï¼šç¼ºå°‘æˆ–æ— æ•ˆçš„ API Key"
                    });
                    updateMessageList();
                    updateInputSafetyInfo("ğŸ”’ ç½‘å…³/é‰´æƒï¼šç¼ºå°‘æˆ–æ— æ•ˆçš„ API Key");
                    recordRequest(0, true, false, false);
                    return;
                }
                if (response.status == 403 || response.status == "403") {
                    const raw = await response.text();
                    let parsed = null;
                    try { parsed = JSON.parse(raw); } catch (e) {}
                    // å¦‚æœæ˜¯æˆ‘ä»¬ AI æ’ä»¶è¿”å›çš„ç»“æ„ï¼Œåˆ™å½’ç±»ä¸º AI å±‚é˜»æ­¢
                    if (parsed && parsed.success === false) {
                        const msg = (parsed.error || parsed.message || '').toString();
                        const isAISafetyBlock = msg.includes('ç”¨æˆ·è¾“å…¥ä¸­æ£€æµ‹åˆ°') || msg.includes('AIå›å¤ä¸­æ£€æµ‹åˆ°');
                        if (isAISafetyBlock) {
                            conversationHistory.push({
                                role: "assistant",
                                content: "ğŸ›¡ï¸ AIå±‚æ£€æµ‹é˜»æ­¢ï¼š" + msg
                            });
                            updateMessageList();
                            updateInputSafetyInfo("ğŸ›¡ï¸ AIå±‚ï¼šè¯·æ±‚è¢«å†…å®¹æ£€æµ‹é˜»æ­¢");
                            recordRequest(0, true, true, false);
                            return;
                        }
                    }
                    // å¦åˆ™æŒ‰ç½‘å…³/é‰´æƒ 403 å¤„ç†
                    const bodyLower = (raw || '').toLowerCase();
                    let reason = "æ¶ˆè´¹è€…è¢«æ‹¦æˆªï¼ˆä¸åœ¨ç™½åå•æˆ–å·²è¢«ç¦æ­¢ï¼‰";
                    if (bodyLower.includes('consumer_name') || bodyLower.includes('forbidden')) {
                        reason = "æ¶ˆè´¹è€…è¢«æ‹¦æˆªï¼ˆconsumer-restrictionï¼‰";
                    }
                    conversationHistory.push({
                        role: "assistant",
                        content: "ğŸš« ç½‘å…³æ‹’ç»è®¿é—®ï¼š" + reason
                    });
                    updateMessageList();
                    updateInputSafetyInfo("ğŸš« ç½‘å…³ï¼šè®¿é—®è¢«æ‹’ç»");
                    recordRequest(0, true, false, false);
                    return;
                }
                if (response.status == 400 || response.status == "400") {
                    try {
                        const errorData = await response.json();
                        const responseTime = 0; // ä¸å†è®¡ç®—å“åº”æ—¶é—´
                        
                        console.log('æ”¶åˆ°400é”™è¯¯:', errorData);
                        console.log('é”™è¯¯æ¶ˆæ¯:', errorData.message);
                        
                        // ç½‘å…³å±‚æ‹¦æˆªéƒ½è§†ä¸ºæ•æ„Ÿä¿¡æ¯
                        conversationHistory.push({
                            role: "assistant",
                            content: "ğŸš« å†…å®¹è¢«ç½‘å…³å±‚è¿‡æ»¤è§„åˆ™é˜»æ­¢ï¼ˆåŒ…å«ç¦æ­¢è¯æ±‡ï¼‰ï¼Œè¯·é‡æ–°è¾“å…¥"
                        });
                        updateMessageList();
                        updateInputSafetyInfo("ğŸš« ç½‘å…³å±‚ï¼šå†…å®¹åŒ…å«ç¦æ­¢è¯æ±‡");
                        updateOutputSafetyInfo("ç­‰å¾…AIå›å¤...");
                        // ç½‘å…³å±‚æ‹¦æˆªé»˜è®¤ä¸ºæ•æ„Ÿä¿¡æ¯
                        recordRequest(responseTime, true, true, false);
                        return;
                    } catch (error) {
                        console.error('è§£æ400é”™è¯¯å“åº”å¤±è´¥:', error);
                        const responseTime = 0; // ä¸å†è®¡ç®—å“åº”æ—¶é—´
                        conversationHistory.push({
                            role: "assistant",
                            content: "ğŸš« å†…å®¹è¢«ç½‘å…³å±‚è¿‡æ»¤è§„åˆ™é˜»æ­¢"
                        });
                        updateMessageList();
                        updateInputSafetyInfo("ğŸš« ç½‘å…³å±‚ï¼šå†…å®¹è¢«é˜»æ­¢");
                        updateOutputSafetyInfo("ç­‰å¾…AIå›å¤...");
                        // ç½‘å…³å±‚æ‹¦æˆªé»˜è®¤ä¸ºæ•æ„Ÿä¿¡æ¯
                        recordRequest(responseTime, true, true, false);
                        return;
                    }
                }

                console.log('çŠ¶æ€ç ä¸æ˜¯400ï¼Œå‡†å¤‡è§£æå“åº”ä½“');
                const result = await response.json();
                
                // æ›´æ–°å“åº”æ—¶é—´
                const responseTime = 0; // ä¸å†è®¡ç®—å“åº”æ—¶é—´
                console.log('å“åº”æ—¶é—´:', responseTime + 'ms');
                console.log('çŠ¶æ€ç ä¸æ˜¯400ï¼Œç»§ç»­å¤„ç†å“åº”');
                console.log('æ”¶åˆ°å“åº”:', result);
                console.log('result.success çš„å€¼:', result.success, 'ç±»å‹:', typeof result.success);

                // è®°å½•ç»Ÿè®¡æ•°æ®
                let wasBlocked = false;
                let hasSensitiveInfo = false;

                if (result.success === true) {
                    try {
                        // ç¬¬äºŒæ­¥ï¼šæ˜¾ç¤ºè¾“å…¥æ£€æµ‹ç»“æœ
                        if (result.safety_check) {
                            console.log('è¾“å…¥æ£€æµ‹ç»“æœ:', result.safety_check);
                            updateInputSafetyInfo(result.safety_check);
                            
                            // æ£€æŸ¥è¾“å…¥æ˜¯å¦å®‰å…¨
                            if (result.safety_check.is_harmful) {
                                // è¾“å…¥æœ‰å®³ï¼Œæ˜¾ç¤ºé”™è¯¯
                                wasBlocked = true;
                                conversationHistory.push({
                                    role: "assistant",
                                    content: "ğŸš« è¾“å…¥å†…å®¹è¢«AIå±‚æ£€æµ‹ä¸ºæœ‰å®³ï¼Œè¯·æ±‚è¢«é˜»æ­¢ï¼ˆå·²é€šè¿‡ç½‘å…³å±‚è¿‡æ»¤ï¼‰"
                                });
                                updateMessageList();
                                // è®°å½•ç»Ÿè®¡æ•°æ®
                                recordRequest(responseTime, wasBlocked, hasSensitiveInfo, true);
                                return;
                            }
                        } else {
                            updateInputSafetyInfo("âš ï¸ è¾“å…¥æ£€æµ‹å¤±è´¥");
                        }

                        // ç¬¬ä¸‰æ­¥ï¼šæ˜¾ç¤ºAIå¤„ç†ä¸­
                        updateOutputSafetyInfo("ğŸ¤– AIæ­£åœ¨ç”Ÿæˆå›å¤...");
                        
                        // å®‰å…¨åœ°è·å–AIå›å¤å†…å®¹
                        let aiContent = "AIå›å¤å†…å®¹è·å–å¤±è´¥";
                        if (result.ai_response && result.ai_response.choices && result.ai_response.choices[0] && result.ai_response.choices[0].message) {
                            aiContent = result.ai_response.choices[0].message.content || "AIå›å¤å†…å®¹ä¸ºç©º";
                        }
                        
                    conversationHistory.push({
                        role: "assistant",
                        content: aiContent
                    });
                        updateMessageList();

                    // ç¬¬å››æ­¥ï¼šæ˜¾ç¤ºè¾“å‡ºæ£€æµ‹ä¸­
                    updateOutputSafetyInfo("ğŸ” æ­£åœ¨æ£€æµ‹AIå›å¤...");
                    
                    // æ¨¡æ‹Ÿæ£€æµ‹å»¶è¿Ÿï¼Œè®©ç”¨æˆ·çœ‹åˆ°æ£€æµ‹è¿‡ç¨‹
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // ç¬¬äº”æ­¥ï¼šæ˜¾ç¤ºè¾“å‡ºæ£€æµ‹ç»“æœ
                    if (result.output_safety_check) {
                        console.log('è¾“å‡ºæ£€æµ‹ç»“æœ:', result.output_safety_check);
                        updateOutputSafetyInfo(result.output_safety_check);
                        
                        // å¦‚æœè¾“å‡ºæœ‰å®³ï¼Œå¯ä»¥åœ¨è¿™é‡Œå¤„ç†
                        if (result.output_safety_check.is_harmful) {
                            // å¯ä»¥é€‰æ‹©æ›¿æ¢AIå›å¤æˆ–æ·»åŠ è­¦å‘Š
                            const lastMessage = conversationHistory[conversationHistory.length - 1];
                            lastMessage.content += "\n\nâš ï¸ æ³¨æ„ï¼šæ­¤å›å¤åŒ…å«æ•æ„Ÿå†…å®¹ï¼Œè¯·è°¨æ…å‚è€ƒã€‚";
                            updateMessageList();
                        }

                        // æ£€æŸ¥æ˜¯å¦æœ‰æ•æ„Ÿä¿¡æ¯å’Œæœ‰å®³ä¿¡æ¯
                        if (result.safety_check && result.safety_check.sensitive_info && result.safety_check.sensitive_info.length > 0) {
                            hasSensitiveInfo = true;
                        }
                        if (result.output_safety_check && result.output_safety_check.sensitive_info && result.output_safety_check.sensitive_info.length > 0) {
                            hasSensitiveInfo = true;
                        }
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰å®³ä¿¡æ¯
                        let hasHarmfulInfo = false;
                        if (result.safety_check && result.safety_check.is_harmful) {
                            hasHarmfulInfo = true;
                        }
                        if (result.output_safety_check && result.output_safety_check.is_harmful) {
                            hasHarmfulInfo = true;
                        }

                        // è®°å½•ç»Ÿè®¡æ•°æ®
                        recordRequest(responseTime, wasBlocked, hasSensitiveInfo, hasHarmfulInfo);
                    } else {
                        updateOutputSafetyInfo("âš ï¸ è¾“å‡ºæ£€æµ‹æœªæ‰§è¡Œ");
                        // å³ä½¿æ²¡æœ‰è¾“å‡ºæ£€æµ‹ï¼Œä¹Ÿè¦è®°å½•ç»Ÿè®¡æ•°æ®
                        recordRequest(responseTime, wasBlocked, hasSensitiveInfo, false);
                    }
                    } catch (error) {
                        console.error('å¤„ç†AIå“åº”æ—¶å‡ºé”™:', error);
                        conversationHistory.push({
                            role: "assistant",
                            content: "âŒ AIå±‚å¤„ç†é”™è¯¯: " + error.message + "ï¼ˆå·²é€šè¿‡ç½‘å…³å±‚è¿‡æ»¤ï¼‰"
                        });
                    updateMessageList();
                        updateInputSafetyInfo("âŒ AIå±‚å¤„ç†å¤±è´¥");
                        recordRequest(responseTime, false, false, false);
                    }
                } else {
                    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    console.log('å¤„ç†å¤±è´¥ï¼Œresult:', result);
                    console.log('result.success ä¸æ˜¯ trueï¼Œå®é™…å€¼:', result.success);
                    const errorMsg = result.error || result.message || "æœªçŸ¥é”™è¯¯";
                    console.log('é”™è¯¯ä¿¡æ¯:', errorMsg);
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ£€æµ‹ç»“æœæ•°æ®
                    if (result.data) {
                        console.log('æ£€æµ‹ç»“æœæ•°æ®:', result.data);
                        
                        // æ˜¾ç¤ºæœ‰å®³ä¿¡æ¯æ£€æµ‹ç»“æœ
                        if (result.data.is_harmful) {
                            let harmfulInfo = "âŒ æ£€æµ‹åˆ°æœ‰å®³å†…å®¹";
                            if (result.data.harmful_categories && result.data.harmful_categories.length > 0) {
                                harmfulInfo += `: ${result.data.harmful_categories.join(', ')}`;
                            }
                            if (result.data.reason) {
                                harmfulInfo += `\nåŸå› : ${result.data.reason}`;
                            }
                            if (result.data.suggestions) {
                                harmfulInfo += `\nå»ºè®®: ${result.data.suggestions}`;
                            }
                            
                            updateInputSafetyInfo({
                                is_harmful: true,
                                confidence: result.data.confidence || 0,
                                reason: result.data.reason || "æ£€æµ‹åˆ°æœ‰å®³å†…å®¹",
                                suggestions: result.data.suggestions || "è¯·ä¿®æ”¹å†…å®¹åé‡è¯•",
                                detected_harmful_types: result.data.harmful_categories || []
                            });
                        }
                        
                        // æ˜¾ç¤ºæ•æ„Ÿä¿¡æ¯æ£€æµ‹ç»“æœ
                        if (result.data.has_sensitive_info && result.data.sensitive_info) {
                            updateOutputSafetyInfo({
                                is_harmful: false,
                                confidence: 1.0,
                                reason: "æ£€æµ‹åˆ°æ•æ„Ÿä¿¡æ¯",
                                suggestions: "è¯·ç§»é™¤æ•æ„Ÿä¿¡æ¯åé‡è¯•",
                                detected_sensitive_types: result.data.sensitive_info.map(item => item.type) || []
                            });
                        }
                    }
                    
                    conversationHistory.push({
                        role: "assistant",
                        content: "âŒ AIå±‚å¤„ç†é”™è¯¯: " + errorMsg + "ï¼ˆå·²é€šè¿‡ç½‘å…³å±‚è¿‡æ»¤ï¼‰"
                    });
                    updateMessageList();
                    
                    if (!result.data) {
                        updateInputSafetyInfo("âŒ AIå±‚å¤„ç†å¤±è´¥");
                    }
                }

            } catch (error) {
                console.error('Error:', error);
                // æ›´æ–°å“åº”æ—¶é—´ï¼ˆå³ä½¿å‡ºé”™ï¼‰
                const responseTime = 0; // ä¸å†è®¡ç®—å“åº”æ—¶é—´
                console.log('è¯·æ±‚å¤±è´¥ï¼Œè€—æ—¶:', responseTime + 'ms');
                
                conversationHistory.push({
                    role: "assistant",
                    content: "è¯·æ±‚å¤±è´¥: " + error.message
                });
                updateMessageList();
                updateInputSafetyInfo("âŒ ç½‘ç»œé”™è¯¯");
                
                // è®°å½•å¤±è´¥çš„è¯·æ±‚ç»Ÿè®¡æ•°æ®
                recordRequest(responseTime, false, false, false);
            }
        }

        // æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
        function updateMessageList() {
            const messageList = document.getElementById('messageList');
            messageList.innerHTML = '';

            conversationHistory.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.role}`;
                
                const roleName = message.role === 'user' ? 'ç”¨æˆ·' : 'AIåŠ©æ‰‹';
                messageDiv.innerHTML = `<strong>${roleName}:</strong> ${message.content}`;
                
                messageList.appendChild(messageDiv);
            });

            // æ»šåŠ¨åˆ°åº•éƒ¨
            messageList.scrollTop = messageList.scrollHeight;
        }



                 // æ›´æ–°è¾“å…¥å®‰å…¨æ£€æµ‹ä¿¡æ¯
         function updateInputSafetyInfo(safetyData) {
             const inputSafetyInfo = document.getElementById('inputSafetyInfo');
            
            if (typeof safetyData === 'string') {
                 // æ£€æŸ¥æ˜¯å¦æ˜¯åŠ¨æ€çŠ¶æ€æ¶ˆæ¯
                 if (safetyData.includes('æ­£åœ¨æ£€æµ‹') || safetyData.includes('AIæ­£åœ¨ç”Ÿæˆ')) {
                     inputSafetyInfo.innerHTML = `<div class="safety-info detecting"><p>${safetyData}</p></div>`;
                 } else if (safetyData.includes('âŒ') || safetyData.includes('âš ï¸')) {
                     inputSafetyInfo.innerHTML = `<div class="safety-info" style="background: #ffebee; border-color: #f44336;"><p>${safetyData}</p></div>`;
                 } else {
                     inputSafetyInfo.innerHTML = `<div class="safety-info"><p>${safetyData}</p></div>`;
                 }
                return;
            }
             
             console.log('æ›´æ–°è¾“å…¥å®‰å…¨æ£€æµ‹:', safetyData);

            let html = '<div class="safety-info">';
            
            if (safetyData.is_harmful) {
                html += '<div class="safety-item">';
                html += '<div class="safety-type">âš ï¸ æ£€æµ‹åˆ°æœ‰å®³å†…å®¹</div>';
                html += `<div>ç½®ä¿¡åº¦: ${safetyData.confidence > 0 ? (safetyData.confidence * 100).toFixed(1) + '%' : 'æœªæ£€æµ‹åˆ°é£é™©'}</div>`;
                html += `<div>åŸå› : ${safetyData.reason}</div>`;
                html += `<div>å»ºè®®: ${safetyData.suggestions}</div>`;
                
                // æ˜¾ç¤ºæ£€æµ‹åˆ°çš„æœ‰å®³ä¿¡æ¯ç±»å‹
                if (safetyData.detected_harmful_types && safetyData.detected_harmful_types.length > 0) {
                    html += `<div><strong>æœ‰å®³ä¿¡æ¯ç±»å‹:</strong> ${safetyData.detected_harmful_types.join(', ')}</div>`;
                }
                html += '</div>';
            } else {
                html += '<div class="safety-item">';
                html += '<div class="safety-type">âœ… å†…å®¹å®‰å…¨</div>';
                html += `<div>ç½®ä¿¡åº¦: ${safetyData.confidence > 0 ? (safetyData.confidence * 100).toFixed(1) + '%' : 'æœªæ£€æµ‹åˆ°é£é™©'}</div>`;
                html += `<div>åŸå› : ${safetyData.reason}</div>`;
                
                // æ˜¾ç¤ºæ£€æµ‹åˆ°çš„æ•æ„Ÿä¿¡æ¯ç±»å‹
                if (safetyData.detected_sensitive_types && safetyData.detected_sensitive_types.length > 0) {
                    html += `<div><strong>æ•æ„Ÿä¿¡æ¯ç±»å‹:</strong> ${safetyData.detected_sensitive_types.join(', ')}</div>`;
                } else {
                    html += '<div><strong>æ•æ„Ÿä¿¡æ¯ç±»å‹:</strong> æœªæ£€æµ‹åˆ°æ•æ„Ÿä¿¡æ¯</div>';
                }
                html += '</div>';
            }

            if (safetyData.sensitive_info && safetyData.sensitive_info.length > 0) {
                html += '<div class="safety-item">';
                html += `<div class="safety-type">ğŸ›¡ï¸ æ•æ„Ÿä¿¡æ¯æ£€æµ‹ (${safetyData.sensitive_count}é¡¹)</div>`;
                
                safetyData.sensitive_info.forEach(info => {
                    html += '<div style="margin: 5px 0; padding: 5px; background: #f8f9fa; border-radius: 3px;">';
                    html += `<div><strong>ç±»å‹:</strong> ${info.type}</div>`;
                    html += `<div><strong>åŸå§‹å€¼:</strong> <span class="safety-value">${info.value}</span></div>`;
                    html += `<div><strong>è„±æ•å€¼:</strong> <span class="masked-value">${info.masked_value}</span></div>`;
                    html += `<div><strong>ä½ç½®:</strong> ${info.position}</div>`;
                    html += '</div>';
                });
                
                html += '</div>';
            }

            html += '</div>';
            inputSafetyInfo.innerHTML = html;
        }

                 // æ›´æ–°è¾“å‡ºå®‰å…¨æ£€æµ‹ä¿¡æ¯
         function updateOutputSafetyInfo(safetyData) {
             const outputSafetyInfo = document.getElementById('outputSafetyInfo');
             
             if (typeof safetyData === 'string') {
                 // æ£€æŸ¥æ˜¯å¦æ˜¯åŠ¨æ€çŠ¶æ€æ¶ˆæ¯
                 if (safetyData.includes('æ­£åœ¨æ£€æµ‹') || safetyData.includes('AIæ­£åœ¨ç”Ÿæˆ')) {
                     outputSafetyInfo.innerHTML = `<div class="safety-info detecting"><p>${safetyData}</p></div>`;
                 } else if (safetyData.includes('âŒ') || safetyData.includes('âš ï¸')) {
                     outputSafetyInfo.innerHTML = `<div class="safety-info" style="background: #ffebee; border-color: #f44336;"><p>${safetyData}</p></div>`;
                 } else {
                     outputSafetyInfo.innerHTML = `<div class="safety-info"><p>${safetyData}</p></div>`;
                 }
                 return;
             }
             
             console.log('æ›´æ–°è¾“å‡ºå®‰å…¨æ£€æµ‹:', safetyData);

            let html = '<div class="safety-info">';
            
            if (safetyData.is_harmful) {
                html += '<div class="safety-item">';
                html += '<div class="safety-type">âš ï¸ æ£€æµ‹åˆ°æœ‰å®³å†…å®¹</div>';
                html += `<div>ç½®ä¿¡åº¦: ${safetyData.confidence > 0 ? (safetyData.confidence * 100).toFixed(1) + '%' : 'æœªæ£€æµ‹åˆ°é£é™©'}</div>`;
                html += `<div>åŸå› : ${safetyData.reason}</div>`;
                html += `<div>å»ºè®®: ${safetyData.suggestions}</div>`;
                
                // æ˜¾ç¤ºæ£€æµ‹åˆ°çš„æœ‰å®³ä¿¡æ¯ç±»å‹
                if (safetyData.detected_harmful_types && safetyData.detected_harmful_types.length > 0) {
                    html += `<div><strong>æœ‰å®³ä¿¡æ¯ç±»å‹:</strong> ${safetyData.detected_harmful_types.join(', ')}</div>`;
                }
                html += '</div>';
            } else {
                html += '<div class="safety-item">';
                html += '<div class="safety-type">âœ… å†…å®¹å®‰å…¨</div>';
                html += `<div>ç½®ä¿¡åº¦: ${safetyData.confidence > 0 ? (safetyData.confidence * 100).toFixed(1) + '%' : 'æœªæ£€æµ‹åˆ°é£é™©'}</div>`;
                html += `<div>åŸå› : ${safetyData.reason}</div>`;
                
                // æ˜¾ç¤ºæ£€æµ‹åˆ°çš„æ•æ„Ÿä¿¡æ¯ç±»å‹
                if (safetyData.detected_sensitive_types && safetyData.detected_sensitive_types.length > 0) {
                    html += `<div><strong>æ•æ„Ÿä¿¡æ¯ç±»å‹:</strong> ${safetyData.detected_sensitive_types.join(', ')}</div>`;
                } else {
                    html += '<div><strong>æ•æ„Ÿä¿¡æ¯ç±»å‹:</strong> æœªæ£€æµ‹åˆ°æ•æ„Ÿä¿¡æ¯</div>';
                }
                html += '</div>';
            }

            if (safetyData.sensitive_info && safetyData.sensitive_info.length > 0) {
                html += '<div class="safety-item">';
                html += `<div class="safety-type">ğŸ›¡ï¸ æ•æ„Ÿä¿¡æ¯æ£€æµ‹ (${safetyData.sensitive_count}é¡¹)</div>`;
                
                safetyData.sensitive_info.forEach(info => {
                    html += '<div style="margin: 5px 0; padding: 5px; background: #f8f9fa; border-radius: 3px;">';
                    html += `<div><strong>ç±»å‹:</strong> ${info.type}</div>`;
                    html += `<div><strong>åŸå§‹å€¼:</strong> <span class="safety-value">${info.value}</span></div>`;
                    html += `<div><strong>è„±æ•å€¼:</strong> <span class="masked-value">${info.masked_value}</span></div>`;
                    html += `<div><strong>ä½ç½®:</strong> ${info.position}</div>`;
                    html += '</div>';
                });
                
                html += '</div>';
            }

            html += '</div>';
            outputSafetyInfo.innerHTML = html;
        }

        // APISIXé…ç½®ç®¡ç†åŠŸèƒ½


        // ä¿å­˜æ¶ˆè´¹è€…é…ç½®
        async function saveConsumerConfig() {
            const username = document.getElementById('consumerUsername').value.trim();
            const apiKey = document.getElementById('consumerApiKey').value.trim();

            if (!username || !apiKey) {
                showStatus('ç”¨æˆ·åå’ŒAPIå¯†é’¥ä¸èƒ½ä¸ºç©ºï¼', 'warning');
                return;
            }

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('aiProxyConsumer', JSON.stringify({ username, apiKey }));
            
            showStatus('æ¶ˆè´¹è€…é…ç½®å·²ä¿å­˜ï¼', 'success');
        }





        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            
            if (!statusDiv) {
                console.error('çŠ¶æ€æ˜¾ç¤ºå…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            let icon = 'â„¹ï¸';
            
            // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
            statusDiv.classList.remove('success', 'error', 'warning', 'info');
            
            switch (type) {
                case 'success':
                    icon = 'âœ…';
                    statusDiv.classList.add('success');
                    break;
                case 'warning':
                    icon = 'âš ï¸';
                    statusDiv.classList.add('warning');
                    break;
                case 'danger':
                    icon = 'âŒ';
                    statusDiv.classList.add('error');
                    break;
                case 'info':
                default:
                    icon = 'â„¹ï¸';
                    statusDiv.classList.add('info');
                    break;
            }
            
            statusDiv.innerHTML = `${icon} ${message}`;
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®é»˜è®¤API URL
            window.apiUrl = '/api/ai-proxy';
            showStatus('ç³»ç»Ÿå·²å°±ç»ªï¼Œä½¿ç”¨æœ¬åœ°APIæ¨¡å¼', 'info');
            
            // æ¢å¤æ¶ˆè´¹è€…é…ç½®
            const savedConfig = localStorage.getItem('aiProxyConsumer');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    document.getElementById('consumerUsername').value = config.username || '';
                    document.getElementById('consumerApiKey').value = config.apiKey || '';
                } catch (error) {
                    console.error('æ¢å¤æ¶ˆè´¹è€…é…ç½®å¤±è´¥:', error);
                }
            }
            
            // å¤„ç†çª—å£å¤§å°å˜åŒ–
            function handleResize() {
                const container = document.querySelector('.container');
                const chatContainer = document.querySelector('.chat-container');
                
                if (window.innerHeight < 600) {
                    // å½“çª—å£é«˜åº¦è¾ƒå°æ—¶ï¼Œè°ƒæ•´å®¹å™¨é«˜åº¦
                    container.style.minHeight = 'auto';
                    container.style.maxHeight = 'none';
                } else {
                    // æ¢å¤æ­£å¸¸é«˜åº¦
                    container.style.minHeight = 'calc(100vh - 40px)';
                    container.style.maxHeight = 'calc(100vh - 40px)';
                }
                
                // ç¡®ä¿èŠå¤©å®¹å™¨æœ‰è¶³å¤Ÿçš„æœ€å°é«˜åº¦
                if (chatContainer) {
                    const minHeight = Math.max(300, window.innerHeight * 0.4);
                    chatContainer.style.minHeight = `${minHeight}px`;
                }
            }
            
            // ç›‘å¬çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', handleResize);
            
            // åˆå§‹è°ƒç”¨ä¸€æ¬¡
            handleResize();
        });
    </script>
</body>
</html> 
