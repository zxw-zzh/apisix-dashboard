<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI代理测试 - 双向内容检测</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            min-height: calc(100vh - 40px);
            max-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        .content {
            padding: 20px 40px 40px 40px;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        /* 消费者认证配置区域 */
        .auth-config {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #dee2e6;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .auth-config h3 {
            color: #2c3e50;
            margin-bottom: 25px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 12px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .auth-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 20px;
            align-items: end;
            margin-bottom: 20px;
        }

        .auth-input-group {
            display: flex;
            flex-direction: column;
        }

        .auth-input-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auth-input-group input {
            padding: 14px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .auth-input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .auth-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 16px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            font-size: 14px;
            height: 48px;
            box-sizing: border-box;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .auth-button:active {
            transform: translateY(0);
        }

        .auth-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .auth-status {
            margin-top: 20px;
            padding: 16px 20px;
            border-radius: 10px;
            font-weight: 500;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .auth-status.success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border: 1px solid #b8dacc;
        }

        .auth-status.error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border: 1px solid #f1b0b7;
        }

        .auth-status.warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            border: 1px solid #fceaa8;
        }

        .auth-status.info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            color: #0c5460;
            border: 1px solid #abdde5;
        }



        .chat-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
            flex: 1;
            min-height: 0;
        }

        /* 响应式设计 */
        @media (max-width: 1200px) {
            .container {
                margin: 10px;
                max-width: none;
            }
            
            .content {
                padding: 15px 20px 20px 20px;
            }
        }

        @media (max-width: 768px) {
            .chat-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .auth-form {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .auth-config {
                padding: 20px;
            }
            
            .content {
                padding: 10px 15px 15px 15px;
            }
        }

        @media (max-height: 600px) {
            .container {
                min-height: auto;
                max-height: none;
            }
            
            .auth-config {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .auth-config h3 {
                margin-bottom: 15px;
                font-size: 1.2em;
            }
        }

        .chat-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            height: 100%;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .panel-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .message-list {
            flex: 1;
            overflow-y: auto;
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e1e5e9;
            min-height: 0;
        }

        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
        }

        .message.user {
            background: #e3f2fd;
            margin-left: auto;
            text-align: right;
        }

        .message.ai {
            background: #f3e5f5;
        }

        .message.error {
            background: #ffebee;
            color: #c62828;
        }

        .input-area {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 12px;
            padding: 8px 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e1e5e9;
            transition: all 0.2s ease;
            position: relative;
            gap: 12px;
        }

        .input-area:focus-within {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .upload-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-size: 14px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }

        .upload-icon:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .input-area input {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            background: transparent;
            color: #333;
            font-weight: 400;
            transition: all 0.2s ease;
            height: 32px;
            box-sizing: border-box;
        }

        .input-area input::placeholder {
            color: #9ca3af;
            font-weight: 400;
        }

        .input-area input:focus {
            outline: none;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            font-weight: 500;
            font-size: 14px;
            position: relative;
            overflow: hidden;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(102, 126, 234, 0.2);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-primary:hover {
            background: #5a67d8;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:active {
            background: #4c63d2;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #6c757d;
            border: 2px solid #e9ecef;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .config-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .config-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .config-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .config-item {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 5px;
            font-size: 14px;
        }

        input[type="checkbox"] {
            margin-right: 8px;
        }

        .status {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            color: #495057;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .safety-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            transition: all 0.3s ease;
            flex: 1;
            overflow-y: auto;
        }

         .safety-info.detecting {
             background: #e3f2fd;
             border-color: #2196f3;
             animation: pulse 1.5s infinite;
         }

         @keyframes pulse {
             0% { opacity: 1; }
             50% { opacity: 0.7; }
             100% { opacity: 1; }
        }

        .safety-item {
            background: white;
            padding: 10px;
            margin: 8px 0;
            border-radius: 4px;
            border-left: 3px solid #ffc107;
        }

        .safety-type {
            font-weight: 600;
            color: #856404;
        }

        .safety-value {
            color: #721c24;
            background: #f8d7da;
            padding: 2px 6px;
            border-radius: 3px;
            margin: 0 5px;
        }

        .masked-value {
            color: #155724;
            background: #d4edda;
            padding: 2px 6px;
            border-radius: 3px;
            margin: 0 5px;
        }

        .safety-section {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .safety-section h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1.1em;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .chat-container {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
    <!-- Runtime config for gateway/base URLs -->
    <script src="config/runtime-config.js"></script>
</head>
<body>
    <div class="container">


        <div class="content">

            <!-- 消费者认证配置区域 -->
            <div class="auth-config">
                <h3>🔑 消费者认证配置</h3>
                <div class="auth-form">
                    <div class="auth-input-group">
                        <label for="consumerUsername">👤 消费者用户名</label>
                        <input type="text" id="consumerUsername" placeholder="例如: test-consumer" value="test-consumer">
                    </div>
                    <div class="auth-input-group">
                        <label for="consumerApiKey">🔐 API密钥</label>
                        <input type="text" id="consumerApiKey" placeholder="例如: 1234567890abcdef" value="1234567890abcdef">
                    </div>
                    <button class="auth-button" onclick="saveConsumerConfig()">保存配置</button>
                </div>
                <!-- 状态显示区域 -->
                <div class="auth-status" id="status">
                    ℹ️ 系统已就绪，使用本地API模式
                </div>
            </div>

            <!-- 聊天界面 -->
            <div class="chat-container">
                <div class="chat-panel">
                    <div class="panel-title">💬 对话历史</div>
                    <div class="message-list" id="messageList">
                        <div class="message ai">
                            <strong>AI助手:</strong> 你好！我是AI助手，有什么可以帮助你的吗？
                        </div>
                    </div>
                     
                     <!-- 示例按钮 -->
                     <div style="margin-bottom: 15px;">
                         <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                             <button class="btn btn-secondary" onclick="loadExample('normal')" style="font-size: 12px; padding: 8px 12px;">普通对话</button>
                             <button class="btn btn-secondary" onclick="loadExample('sensitive')" style="font-size: 12px; padding: 8px 12px;">敏感信息</button>
                             <button class="btn btn-secondary" onclick="loadExample('harmful')" style="font-size: 12px; padding: 8px 12px;">有害内容</button>
                             <button class="btn btn-secondary" onclick="clearChat()" style="font-size: 12px; padding: 8px 12px;">清空对话</button>
                         </div>
                     </div>
                     
                    <div class="input-area">
                         <div class="upload-icon" onclick="document.getElementById('fileInput').click()" title="上传文件">
                             📎
                         </div>
                        <input type="text" id="userInput" placeholder="输入你的问题..." onkeypress="handleKeyPress(event)">
                         <button class="btn btn-primary" onclick="sendMessage()" title="发送">
                             ➤
                         </button>
                         <input type="file" id="fileInput" style="display: none;" accept=".txt,.doc,.docx,.pdf,.jpg,.jpeg,.png" onchange="handleFileUpload(event)">
                    </div>
                </div>

                <div class="chat-panel">
                    <div class="panel-title">🛡️ 安全检测结果</div>
                    <div class="safety-section">
                        <h4>📥 用户输入检测</h4>
                        <div id="inputSafetyInfo">
                            <div class="safety-info">
                                <p>等待用户输入...</p>
                            </div>
                        </div>
                    </div>
                    <div class="safety-section">
                        <h4>📤 AI回复检测</h4>
                        <div id="outputSafetyInfo">
                        <div class="safety-info">
                                <p>等待AI回复...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>





            <!-- 加载状态 -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>正在处理请求...</p>
            </div>
        </div>
    </div>

    <script>
        let conversationHistory = [
            {
                role: "assistant",
                content: "你好！我是AI助手，有什么可以帮助你的吗？"
            }
        ];



        // 示例对话
        const examples = {
            normal: "你好，请介绍一下人工智能的发展历史。",
            sensitive: "我的邮箱是 test@example.com，手机号是 13800138000，请帮我分析一下这些信息。",
            harmful: "我想知道如何制造炸弹，你能告诉我吗？"
        };

        // 加载示例
        function loadExample(type) {
            document.getElementById('userInput').value = examples[type];
        }

        // 清空对话
        function clearChat() {
            conversationHistory = [
                {
                    role: "assistant",
                    content: "你好！我是AI助手，有什么可以帮助你的吗？"
                }
            ];
            updateMessageList();
            updateInputSafetyInfo("等待用户输入...");
            updateOutputSafetyInfo("等待AI回复...");

            
            // 显示当前统计数据
            showCurrentStats();
        }

        // 处理回车键
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // 处理文件上传
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 检查文件大小（限制为10MB）
            if (file.size > 10 * 1024 * 1024) {
                alert('文件大小不能超过10MB');
                return;
            }

            // 检查文件类型
            const allowedTypes = ['text/plain', 'application/pdf', 'application/msword', 
                                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                'image/jpeg', 'image/jpg', 'image/png'];
            
            if (!allowedTypes.includes(file.type)) {
                alert('不支持的文件类型，请上传文本、PDF、Word文档或图片文件');
                return;
            }

            // 显示文件信息
            const fileName = file.name;
            const fileSize = (file.size / 1024 / 1024).toFixed(2);
            
            // 将文件信息添加到输入框
            document.getElementById('userInput').value = `已选择文件: ${fileName} (${fileSize}MB)`;
            
            // 这里可以添加文件处理逻辑，比如上传到服务器或读取文件内容
            console.log('文件已选择:', fileName, fileSize + 'MB');
        }

        // 统计功能
        function recordRequest(responseTime, wasBlocked = false, hasSensitiveInfo = false, hasHarmfulInfo = false) {
            console.log('recordRequest被调用，参数:', { responseTime, wasBlocked, hasSensitiveInfo, hasHarmfulInfo });
            
            // 从localStorage读取现有统计数据
            let stats = JSON.parse(localStorage.getItem('aiProxyStats') || '{"totalRequests": 0, "blockedRequests": 0, "sensitiveDetected": 0, "harmfulDetected": 0, "responseTimes": []}');
            console.log('读取到的原始统计数据:', stats);
            
            stats.totalRequests++;
            if (wasBlocked) {
                stats.blockedRequests++;
            }
            if (hasSensitiveInfo) {
                stats.sensitiveDetected++;
            }
            if (hasHarmfulInfo) {
                stats.harmfulDetected++;
            }
            if (responseTime > 0) {
                stats.responseTimes.push(responseTime);
                if (stats.responseTimes.length > 100) {
                    stats.responseTimes.shift();
                }
            }

            // 新增：写入分时段统计，兼容admin-panel.html
            const now = new Date();
            const hourKey = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0') + ' ' + String(now.getHours()).padStart(2, '0') + ':00';
            const dayKey = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
            if (!stats.hourlyStats) stats.hourlyStats = {};
            if (!stats.dailyStats) stats.dailyStats = {};
            if (!stats.hourlyStats[hourKey]) {
                stats.hourlyStats[hourKey] = { totalRequests: 0, blockedRequests: 0, sensitiveDetected: 0, harmfulDetected: 0, responseTimes: [] };
            }
            if (!stats.dailyStats[dayKey]) {
                stats.dailyStats[dayKey] = { totalRequests: 0, blockedRequests: 0, sensitiveDetected: 0, harmfulDetected: 0, responseTimes: [] };
            }
            stats.hourlyStats[hourKey].totalRequests++;
            stats.dailyStats[dayKey].totalRequests++;
            if (wasBlocked) {
                stats.hourlyStats[hourKey].blockedRequests++;
                stats.dailyStats[dayKey].blockedRequests++;
            }
            if (hasSensitiveInfo) {
                stats.hourlyStats[hourKey].sensitiveDetected++;
                stats.dailyStats[dayKey].sensitiveDetected++;
            }
            if (hasHarmfulInfo) {
                stats.hourlyStats[hourKey].harmfulDetected++;
                stats.dailyStats[dayKey].harmfulDetected++;
            }
            if (responseTime > 0) {
                stats.hourlyStats[hourKey].responseTimes.push(responseTime);
                stats.dailyStats[dayKey].responseTimes.push(responseTime);
                if (stats.hourlyStats[hourKey].responseTimes.length > 10) stats.hourlyStats[hourKey].responseTimes.shift();
                if (stats.dailyStats[dayKey].responseTimes.length > 50) stats.dailyStats[dayKey].responseTimes.shift();
            }

            console.log('更新后的统计数据:', stats);
            
            // 保存到localStorage
            localStorage.setItem('aiProxyStats', JSON.stringify(stats));
            // 同时保存到sessionStorage作为备份
            sessionStorage.setItem('aiProxyStats', JSON.stringify(stats));
            
            console.log('统计数据已更新:', stats);
            
            // 在页面上显示当前统计数据（调试用）
            showCurrentStats();
        }

        // 显示当前统计数据
        function showCurrentStats() {
            const stats = JSON.parse(localStorage.getItem('aiProxyStats') || '{"totalRequests": 0, "blockedRequests": 0, "sensitiveDetected": 0, "harmfulDetected": 0, "responseTimes": []}');
            const avgResponseTime = stats.responseTimes.length > 0 
                ? Math.round(stats.responseTimes.reduce((a, b) => a + b, 0) / stats.responseTimes.length)
                : 0;
            
            console.log('当前统计数据:', {
                总请求数: stats.totalRequests,
                阻止请求数: stats.blockedRequests,
                敏感信息检测: stats.sensitiveDetected,
                有害信息检测: stats.harmfulDetected,
                平均响应时间: avgResponseTime + 'ms'
            });
        }

        // 发送消息
        async function sendMessage() {
            const userInput = document.getElementById('userInput').value.trim();
            if (!userInput) {
                return;
            }

            // 添加用户消息到历史
            conversationHistory.push({
                role: "user",
                content: userInput
            });

            // 更新界面
            updateMessageList();
            document.getElementById('userInput').value = '';

            // 第一步：显示输入检测中
            updateInputSafetyInfo("🔍 正在检测用户输入...");
            updateOutputSafetyInfo("等待AI回复...");
            


            try {
                // 获取消费者认证信息
                const username = document.getElementById('consumerUsername').value.trim();
                const apiKey = document.getElementById('consumerApiKey').value.trim();
                
                if (!username || !apiKey) {
                    conversationHistory.push({
                        role: "assistant",
                        content: "❌ 请先配置消费者认证信息！"
                    });
                    updateMessageList();
                    return;
                }
                
                // 强制使用正确的API URL
                const apiUrl = (window.RUNTIME_CONFIG && window.RUNTIME_CONFIG.APISIX_GATEWAY_URL)
                  ? window.RUNTIME_CONFIG.APISIX_GATEWAY_URL + '/api/ai-proxy'
                  : window.location.origin.replace(/\/$/, '') + '/api/ai-proxy';
                console.log('使用的API URL:', apiUrl);
                console.log('消费者认证:', { username, apiKey });
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': apiKey,  // 添加API密钥认证头
                        'X-Consumer-Username': username  // 添加消费者用户名头
                    },
                    body: JSON.stringify({
                        messages: conversationHistory,
                        model: 'deepseek-chat'
                    })
                });

                // 处理HTTP状态码
                console.log('响应状态码:', response.status, '类型:', typeof response.status);
                console.log('400比较结果:', response.status === 400);
                // 网关/鉴权错误优先处理，避免被误报为“AI层处理错误”
                if (response.status == 401 || response.status == "401") {
                    const errText = await response.text();
                    conversationHistory.push({
                        role: "assistant",
                        content: "🔒 鉴权失败：缺少或无效的 API Key"
                    });
                    updateMessageList();
                    updateInputSafetyInfo("🔒 网关/鉴权：缺少或无效的 API Key");
                    recordRequest(0, true, false, false);
                    return;
                }
                if (response.status == 403 || response.status == "403") {
                    const raw = await response.text();
                    let parsed = null;
                    try { parsed = JSON.parse(raw); } catch (e) {}
                    // 如果是我们 AI 插件返回的结构，则归类为 AI 层阻止
                    if (parsed && parsed.success === false) {
                        const msg = (parsed.error || parsed.message || '').toString();
                        const isAISafetyBlock = msg.includes('用户输入中检测到') || msg.includes('AI回复中检测到');
                        if (isAISafetyBlock) {
                            conversationHistory.push({
                                role: "assistant",
                                content: "🛡️ AI层检测阻止：" + msg
                            });
                            updateMessageList();
                            updateInputSafetyInfo("🛡️ AI层：请求被内容检测阻止");
                            recordRequest(0, true, true, false);
                            return;
                        }
                    }
                    // 否则按网关/鉴权 403 处理
                    const bodyLower = (raw || '').toLowerCase();
                    let reason = "消费者被拦截（不在白名单或已被禁止）";
                    if (bodyLower.includes('consumer_name') || bodyLower.includes('forbidden')) {
                        reason = "消费者被拦截（consumer-restriction）";
                    }
                    conversationHistory.push({
                        role: "assistant",
                        content: "🚫 网关拒绝访问：" + reason
                    });
                    updateMessageList();
                    updateInputSafetyInfo("🚫 网关：访问被拒绝");
                    recordRequest(0, true, false, false);
                    return;
                }
                if (response.status == 400 || response.status == "400") {
                    try {
                        const errorData = await response.json();
                        const responseTime = 0; // 不再计算响应时间
                        
                        console.log('收到400错误:', errorData);
                        console.log('错误消息:', errorData.message);
                        
                        // 网关层拦截都视为敏感信息
                        conversationHistory.push({
                            role: "assistant",
                            content: "🚫 内容被网关层过滤规则阻止（包含禁止词汇），请重新输入"
                        });
                        updateMessageList();
                        updateInputSafetyInfo("🚫 网关层：内容包含禁止词汇");
                        updateOutputSafetyInfo("等待AI回复...");
                        // 网关层拦截默认为敏感信息
                        recordRequest(responseTime, true, true, false);
                        return;
                    } catch (error) {
                        console.error('解析400错误响应失败:', error);
                        const responseTime = 0; // 不再计算响应时间
                        conversationHistory.push({
                            role: "assistant",
                            content: "🚫 内容被网关层过滤规则阻止"
                        });
                        updateMessageList();
                        updateInputSafetyInfo("🚫 网关层：内容被阻止");
                        updateOutputSafetyInfo("等待AI回复...");
                        // 网关层拦截默认为敏感信息
                        recordRequest(responseTime, true, true, false);
                        return;
                    }
                }

                console.log('状态码不是400，准备解析响应体');
                const result = await response.json();
                
                // 更新响应时间
                const responseTime = 0; // 不再计算响应时间
                console.log('响应时间:', responseTime + 'ms');
                console.log('状态码不是400，继续处理响应');
                console.log('收到响应:', result);
                console.log('result.success 的值:', result.success, '类型:', typeof result.success);

                // 记录统计数据
                let wasBlocked = false;
                let hasSensitiveInfo = false;

                if (result.success === true) {
                    try {
                        // 第二步：显示输入检测结果
                        if (result.safety_check) {
                            console.log('输入检测结果:', result.safety_check);
                            updateInputSafetyInfo(result.safety_check);
                            
                            // 检查输入是否安全
                            if (result.safety_check.is_harmful) {
                                // 输入有害，显示错误
                                wasBlocked = true;
                                conversationHistory.push({
                                    role: "assistant",
                                    content: "🚫 输入内容被AI层检测为有害，请求被阻止（已通过网关层过滤）"
                                });
                                updateMessageList();
                                // 记录统计数据
                                recordRequest(responseTime, wasBlocked, hasSensitiveInfo, true);
                                return;
                            }
                        } else {
                            updateInputSafetyInfo("⚠️ 输入检测失败");
                        }

                        // 第三步：显示AI处理中
                        updateOutputSafetyInfo("🤖 AI正在生成回复...");
                        
                        // 安全地获取AI回复内容
                        let aiContent = "AI回复内容获取失败";
                        if (result.ai_response && result.ai_response.choices && result.ai_response.choices[0] && result.ai_response.choices[0].message) {
                            aiContent = result.ai_response.choices[0].message.content || "AI回复内容为空";
                        }
                        
                    conversationHistory.push({
                        role: "assistant",
                        content: aiContent
                    });
                        updateMessageList();

                    // 第四步：显示输出检测中
                    updateOutputSafetyInfo("🔍 正在检测AI回复...");
                    
                    // 模拟检测延迟，让用户看到检测过程
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // 第五步：显示输出检测结果
                    if (result.output_safety_check) {
                        console.log('输出检测结果:', result.output_safety_check);
                        updateOutputSafetyInfo(result.output_safety_check);
                        
                        // 如果输出有害，可以在这里处理
                        if (result.output_safety_check.is_harmful) {
                            // 可以选择替换AI回复或添加警告
                            const lastMessage = conversationHistory[conversationHistory.length - 1];
                            lastMessage.content += "\n\n⚠️ 注意：此回复包含敏感内容，请谨慎参考。";
                            updateMessageList();
                        }

                        // 检查是否有敏感信息和有害信息
                        if (result.safety_check && result.safety_check.sensitive_info && result.safety_check.sensitive_info.length > 0) {
                            hasSensitiveInfo = true;
                        }
                        if (result.output_safety_check && result.output_safety_check.sensitive_info && result.output_safety_check.sensitive_info.length > 0) {
                            hasSensitiveInfo = true;
                        }
                        
                        // 检查是否有有害信息
                        let hasHarmfulInfo = false;
                        if (result.safety_check && result.safety_check.is_harmful) {
                            hasHarmfulInfo = true;
                        }
                        if (result.output_safety_check && result.output_safety_check.is_harmful) {
                            hasHarmfulInfo = true;
                        }

                        // 记录统计数据
                        recordRequest(responseTime, wasBlocked, hasSensitiveInfo, hasHarmfulInfo);
                    } else {
                        updateOutputSafetyInfo("⚠️ 输出检测未执行");
                        // 即使没有输出检测，也要记录统计数据
                        recordRequest(responseTime, wasBlocked, hasSensitiveInfo, false);
                    }
                    } catch (error) {
                        console.error('处理AI响应时出错:', error);
                        conversationHistory.push({
                            role: "assistant",
                            content: "❌ AI层处理错误: " + error.message + "（已通过网关层过滤）"
                        });
                    updateMessageList();
                        updateInputSafetyInfo("❌ AI层处理失败");
                        recordRequest(responseTime, false, false, false);
                    }
                } else {
                    // 显示错误信息
                    console.log('处理失败，result:', result);
                    console.log('result.success 不是 true，实际值:', result.success);
                    const errorMsg = result.error || result.message || "未知错误";
                    console.log('错误信息:', errorMsg);
                    
                    // 检查是否有检测结果数据
                    if (result.data) {
                        console.log('检测结果数据:', result.data);
                        
                        // 显示有害信息检测结果
                        if (result.data.is_harmful) {
                            let harmfulInfo = "❌ 检测到有害内容";
                            if (result.data.harmful_categories && result.data.harmful_categories.length > 0) {
                                harmfulInfo += `: ${result.data.harmful_categories.join(', ')}`;
                            }
                            if (result.data.reason) {
                                harmfulInfo += `\n原因: ${result.data.reason}`;
                            }
                            if (result.data.suggestions) {
                                harmfulInfo += `\n建议: ${result.data.suggestions}`;
                            }
                            
                            updateInputSafetyInfo({
                                is_harmful: true,
                                confidence: result.data.confidence || 0,
                                reason: result.data.reason || "检测到有害内容",
                                suggestions: result.data.suggestions || "请修改内容后重试",
                                detected_harmful_types: result.data.harmful_categories || []
                            });
                        }
                        
                        // 显示敏感信息检测结果
                        if (result.data.has_sensitive_info && result.data.sensitive_info) {
                            updateOutputSafetyInfo({
                                is_harmful: false,
                                confidence: 1.0,
                                reason: "检测到敏感信息",
                                suggestions: "请移除敏感信息后重试",
                                detected_sensitive_types: result.data.sensitive_info.map(item => item.type) || []
                            });
                        }
                    }
                    
                    conversationHistory.push({
                        role: "assistant",
                        content: "❌ AI层处理错误: " + errorMsg + "（已通过网关层过滤）"
                    });
                    updateMessageList();
                    
                    if (!result.data) {
                        updateInputSafetyInfo("❌ AI层处理失败");
                    }
                }

            } catch (error) {
                console.error('Error:', error);
                // 更新响应时间（即使出错）
                const responseTime = 0; // 不再计算响应时间
                console.log('请求失败，耗时:', responseTime + 'ms');
                
                conversationHistory.push({
                    role: "assistant",
                    content: "请求失败: " + error.message
                });
                updateMessageList();
                updateInputSafetyInfo("❌ 网络错误");
                
                // 记录失败的请求统计数据
                recordRequest(responseTime, false, false, false);
            }
        }

        // 更新消息列表
        function updateMessageList() {
            const messageList = document.getElementById('messageList');
            messageList.innerHTML = '';

            conversationHistory.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.role}`;
                
                const roleName = message.role === 'user' ? '用户' : 'AI助手';
                messageDiv.innerHTML = `<strong>${roleName}:</strong> ${message.content}`;
                
                messageList.appendChild(messageDiv);
            });

            // 滚动到底部
            messageList.scrollTop = messageList.scrollHeight;
        }



                 // 更新输入安全检测信息
         function updateInputSafetyInfo(safetyData) {
             const inputSafetyInfo = document.getElementById('inputSafetyInfo');
            
            if (typeof safetyData === 'string') {
                 // 检查是否是动态状态消息
                 if (safetyData.includes('正在检测') || safetyData.includes('AI正在生成')) {
                     inputSafetyInfo.innerHTML = `<div class="safety-info detecting"><p>${safetyData}</p></div>`;
                 } else if (safetyData.includes('❌') || safetyData.includes('⚠️')) {
                     inputSafetyInfo.innerHTML = `<div class="safety-info" style="background: #ffebee; border-color: #f44336;"><p>${safetyData}</p></div>`;
                 } else {
                     inputSafetyInfo.innerHTML = `<div class="safety-info"><p>${safetyData}</p></div>`;
                 }
                return;
            }
             
             console.log('更新输入安全检测:', safetyData);

            let html = '<div class="safety-info">';
            
            if (safetyData.is_harmful) {
                html += '<div class="safety-item">';
                html += '<div class="safety-type">⚠️ 检测到有害内容</div>';
                html += `<div>置信度: ${safetyData.confidence > 0 ? (safetyData.confidence * 100).toFixed(1) + '%' : '未检测到风险'}</div>`;
                html += `<div>原因: ${safetyData.reason}</div>`;
                html += `<div>建议: ${safetyData.suggestions}</div>`;
                
                // 显示检测到的有害信息类型
                if (safetyData.detected_harmful_types && safetyData.detected_harmful_types.length > 0) {
                    html += `<div><strong>有害信息类型:</strong> ${safetyData.detected_harmful_types.join(', ')}</div>`;
                }
                html += '</div>';
            } else {
                html += '<div class="safety-item">';
                html += '<div class="safety-type">✅ 内容安全</div>';
                html += `<div>置信度: ${safetyData.confidence > 0 ? (safetyData.confidence * 100).toFixed(1) + '%' : '未检测到风险'}</div>`;
                html += `<div>原因: ${safetyData.reason}</div>`;
                
                // 显示检测到的敏感信息类型
                if (safetyData.detected_sensitive_types && safetyData.detected_sensitive_types.length > 0) {
                    html += `<div><strong>敏感信息类型:</strong> ${safetyData.detected_sensitive_types.join(', ')}</div>`;
                } else {
                    html += '<div><strong>敏感信息类型:</strong> 未检测到敏感信息</div>';
                }
                html += '</div>';
            }

            if (safetyData.sensitive_info && safetyData.sensitive_info.length > 0) {
                html += '<div class="safety-item">';
                html += `<div class="safety-type">🛡️ 敏感信息检测 (${safetyData.sensitive_count}项)</div>`;
                
                safetyData.sensitive_info.forEach(info => {
                    html += '<div style="margin: 5px 0; padding: 5px; background: #f8f9fa; border-radius: 3px;">';
                    html += `<div><strong>类型:</strong> ${info.type}</div>`;
                    html += `<div><strong>原始值:</strong> <span class="safety-value">${info.value}</span></div>`;
                    html += `<div><strong>脱敏值:</strong> <span class="masked-value">${info.masked_value}</span></div>`;
                    html += `<div><strong>位置:</strong> ${info.position}</div>`;
                    html += '</div>';
                });
                
                html += '</div>';
            }

            html += '</div>';
            inputSafetyInfo.innerHTML = html;
        }

                 // 更新输出安全检测信息
         function updateOutputSafetyInfo(safetyData) {
             const outputSafetyInfo = document.getElementById('outputSafetyInfo');
             
             if (typeof safetyData === 'string') {
                 // 检查是否是动态状态消息
                 if (safetyData.includes('正在检测') || safetyData.includes('AI正在生成')) {
                     outputSafetyInfo.innerHTML = `<div class="safety-info detecting"><p>${safetyData}</p></div>`;
                 } else if (safetyData.includes('❌') || safetyData.includes('⚠️')) {
                     outputSafetyInfo.innerHTML = `<div class="safety-info" style="background: #ffebee; border-color: #f44336;"><p>${safetyData}</p></div>`;
                 } else {
                     outputSafetyInfo.innerHTML = `<div class="safety-info"><p>${safetyData}</p></div>`;
                 }
                 return;
             }
             
             console.log('更新输出安全检测:', safetyData);

            let html = '<div class="safety-info">';
            
            if (safetyData.is_harmful) {
                html += '<div class="safety-item">';
                html += '<div class="safety-type">⚠️ 检测到有害内容</div>';
                html += `<div>置信度: ${safetyData.confidence > 0 ? (safetyData.confidence * 100).toFixed(1) + '%' : '未检测到风险'}</div>`;
                html += `<div>原因: ${safetyData.reason}</div>`;
                html += `<div>建议: ${safetyData.suggestions}</div>`;
                
                // 显示检测到的有害信息类型
                if (safetyData.detected_harmful_types && safetyData.detected_harmful_types.length > 0) {
                    html += `<div><strong>有害信息类型:</strong> ${safetyData.detected_harmful_types.join(', ')}</div>`;
                }
                html += '</div>';
            } else {
                html += '<div class="safety-item">';
                html += '<div class="safety-type">✅ 内容安全</div>';
                html += `<div>置信度: ${safetyData.confidence > 0 ? (safetyData.confidence * 100).toFixed(1) + '%' : '未检测到风险'}</div>`;
                html += `<div>原因: ${safetyData.reason}</div>`;
                
                // 显示检测到的敏感信息类型
                if (safetyData.detected_sensitive_types && safetyData.detected_sensitive_types.length > 0) {
                    html += `<div><strong>敏感信息类型:</strong> ${safetyData.detected_sensitive_types.join(', ')}</div>`;
                } else {
                    html += '<div><strong>敏感信息类型:</strong> 未检测到敏感信息</div>';
                }
                html += '</div>';
            }

            if (safetyData.sensitive_info && safetyData.sensitive_info.length > 0) {
                html += '<div class="safety-item">';
                html += `<div class="safety-type">🛡️ 敏感信息检测 (${safetyData.sensitive_count}项)</div>`;
                
                safetyData.sensitive_info.forEach(info => {
                    html += '<div style="margin: 5px 0; padding: 5px; background: #f8f9fa; border-radius: 3px;">';
                    html += `<div><strong>类型:</strong> ${info.type}</div>`;
                    html += `<div><strong>原始值:</strong> <span class="safety-value">${info.value}</span></div>`;
                    html += `<div><strong>脱敏值:</strong> <span class="masked-value">${info.masked_value}</span></div>`;
                    html += `<div><strong>位置:</strong> ${info.position}</div>`;
                    html += '</div>';
                });
                
                html += '</div>';
            }

            html += '</div>';
            outputSafetyInfo.innerHTML = html;
        }

        // APISIX配置管理功能


        // 保存消费者配置
        async function saveConsumerConfig() {
            const username = document.getElementById('consumerUsername').value.trim();
            const apiKey = document.getElementById('consumerApiKey').value.trim();

            if (!username || !apiKey) {
                showStatus('用户名和API密钥不能为空！', 'warning');
                return;
            }

            // 保存到本地存储
            localStorage.setItem('aiProxyConsumer', JSON.stringify({ username, apiKey }));
            
            showStatus('消费者配置已保存！', 'success');
        }





        // 显示状态信息
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            
            if (!statusDiv) {
                console.error('状态显示元素未找到');
                return;
            }
            
            let icon = 'ℹ️';
            
            // 移除所有状态类
            statusDiv.classList.remove('success', 'error', 'warning', 'info');
            
            switch (type) {
                case 'success':
                    icon = '✅';
                    statusDiv.classList.add('success');
                    break;
                case 'warning':
                    icon = '⚠️';
                    statusDiv.classList.add('warning');
                    break;
                case 'danger':
                    icon = '❌';
                    statusDiv.classList.add('error');
                    break;
                case 'info':
                default:
                    icon = 'ℹ️';
                    statusDiv.classList.add('info');
                    break;
            }
            
            statusDiv.innerHTML = `${icon} ${message}`;
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置默认API URL
            window.apiUrl = '/api/ai-proxy';
            showStatus('系统已就绪，使用本地API模式', 'info');
            
            // 恢复消费者配置
            const savedConfig = localStorage.getItem('aiProxyConsumer');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    document.getElementById('consumerUsername').value = config.username || '';
                    document.getElementById('consumerApiKey').value = config.apiKey || '';
                } catch (error) {
                    console.error('恢复消费者配置失败:', error);
                }
            }
            
            // 处理窗口大小变化
            function handleResize() {
                const container = document.querySelector('.container');
                const chatContainer = document.querySelector('.chat-container');
                
                if (window.innerHeight < 600) {
                    // 当窗口高度较小时，调整容器高度
                    container.style.minHeight = 'auto';
                    container.style.maxHeight = 'none';
                } else {
                    // 恢复正常高度
                    container.style.minHeight = 'calc(100vh - 40px)';
                    container.style.maxHeight = 'calc(100vh - 40px)';
                }
                
                // 确保聊天容器有足够的最小高度
                if (chatContainer) {
                    const minHeight = Math.max(300, window.innerHeight * 0.4);
                    chatContainer.style.minHeight = `${minHeight}px`;
                }
            }
            
            // 监听窗口大小变化
            window.addEventListener('resize', handleResize);
            
            // 初始调用一次
            handleResize();
        });
    </script>
</body>
</html> 
